<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球开源开发者3D地球分布模型</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
            font-family: Arial, sans-serif;
        }
        #container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        #instructions {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 10;
        }
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 100;
            display: none;
            border: 1px solid #fff;
        }
        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            z-index: 100;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        #topCountries {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            z-index: 100;
            font-size: 14px;
            min-width: 200px;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .rank-number {
            font-weight: bold;
            color: #44ff44;
        }
    </style>
</head>
<body>
    <div id="instructions">拖动地球旋转 | Drag to rotate the Earth</div>
    <div id="container"></div>
    <div id="tooltip"></div>
    <div id="legend">
        <div style="font-weight: bold; margin-bottom: 10px;">洲际分布图例</div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff4444;"></div>
            <span>亚洲 (Asia)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4444ff;"></div>
            <span>北美洲 (North America)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #44ff44;"></div>
            <span>欧洲 (Europe)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffff44;"></div>
            <span>南美洲 (South America)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff44ff;"></div>
            <span>非洲 (Africa)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #44ffff;"></div>
            <span>大洋洲 (Oceania)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffffff;"></div>
            <span>北极地区 (Arctic)</span>
        </div>
    </div>
    <div id="topCountries">
        <div style="font-weight: bold; margin-bottom: 10px;">开发者数量排行榜 Top 10</div>
        <div class="rank-item">
            <span class="rank-number">1.</span>
            <span>美国: 476.16万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">2.</span>
            <span>印度: 239.98万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">3.</span>
            <span>中国: 198.29万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">4.</span>
            <span>英国: 98.3万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">5.</span>
            <span>德国: 95万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">6.</span>
            <span>巴西: 80万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">7.</span>
            <span>加拿大: 79.69万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">8.</span>
            <span>法国: 68.88万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">9.</span>
            <span>俄罗斯: 57.14万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">10.</span>
            <span>澳大利亚: 38.03万</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 经纬度转换为3D坐标的函数
        function latLongToVector3(lat, lon, radius) {
            const phi = (90 - lat) * Math.PI / 180;
            const theta = (lon + 180) * Math.PI / 180;

            return new THREE.Vector3(
                -radius * Math.sin(phi) * Math.cos(theta),
                radius * Math.cos(phi),
                radius * Math.sin(phi) * Math.sin(theta)
            );
        }

        // 场景初始化
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 2;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);

        // 创建基础地球
        const geometry = new THREE.SphereGeometry(1, 64, 64);

        const textureLoader = new THREE.TextureLoader();
        const map = textureLoader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');
        const bumpMap = textureLoader.load('https://threejs.org/examples/textures/planets/earth_normal_2048.jpg');
        const specularMap = textureLoader.load('https://threejs.org/examples/textures/planets/earth_specular_2048.jpg');

        const material = new THREE.MeshPhongMaterial({
            map: map,
            bumpMap: bumpMap,
            bumpScale: 0.05,
            specularMap: specularMap,
            specular: new THREE.Color(0x333333),
            shininess: 5
        });

        const earth = new THREE.Mesh(geometry, material);
        scene.add(earth);

        // 洲颜色映射
        const continentColors = {
            Asia: 0xff4444,       // 红色
            NorthAmerica: 0x4444ff, // 蓝色
            Europe: 0x44ff44,      // 绿色
            SouthAmerica: 0xffff44, // 黄色
            Africa: 0xff44ff,       // 紫红色
            Oceania: 0x44ffff,     // 青色
            Arctic: 0xffffff       // 白色
        };

        // 国家开发者数据（使用首都经纬度，按洲分组）
        const countryData = [
            // 亚洲
            { country: 'China', count: 198.29, capital: { lat: 39.9042, lon: 116.4074 }, rawCount: '198.29万', continent: 'Asia' }, // 北京
            { country: 'Japan', count: 36.79, capital: { lat: 35.6895, lon: 139.6917 }, rawCount: '36.79万', continent: 'Asia' }, // 东京
            { country: 'Mongolia', count: 0.44, capital: { lat: 47.8864, lon: 106.9057 }, rawCount: '0.44万', continent: 'Asia' }, // 乌兰巴托
            { country: 'Kazakhstan', count: 3.57, capital: { lat: 51.1605, lon: 71.4704 }, rawCount: '3.57万', continent: 'Asia' }, // 努尔苏丹
            { country: 'Iran', count: 10.36, capital: { lat: 35.6892, lon: 51.3890 }, rawCount: '10.36万', continent: 'Asia' }, // 德黑兰
            { country: 'Indonesia', count: 36.64, capital: { lat: -6.2088, lon: 106.8456 }, rawCount: '36.64万', continent: 'Asia' }, // 雅加达
            { country: 'Malaysia', count: 5.97, capital: { lat: 3.1390, lon: 101.6869 }, rawCount: '5.97万', continent: 'Asia' }, // 吉隆坡
            { country: 'Thailand', count: 7.64, capital: { lat: 13.7563, lon: 100.5018 }, rawCount: '7.64万', continent: 'Asia' }, // 曼谷
            { country: 'Vietnam', count: 21.5, capital: { lat: 21.0278, lon: 105.8342 }, rawCount: '21.5万', continent: 'Asia' }, // 河内
            { country: 'Pakistan', count: 18.89, capital: { lat: 33.6844, lon: 73.0479 }, rawCount: '18.89万', continent: 'Asia' }, // 伊斯兰堡
            { country: 'Saudi Arabia', count: 3.35, capital: { lat: 24.6877, lon: 46.7219 }, rawCount: '3.35万', continent: 'Asia' }, // 利雅得
            { country: 'Yemen', count: 0.39, capital: { lat: 15.3694, lon: 44.1910 }, rawCount: '0.39万', continent: 'Asia' }, // 萨那
            { country: 'Israel', count: 9.14, capital: { lat: 31.7683, lon: 35.2137 }, rawCount: '9.14万', continent: 'Asia' }, // 耶路撒冷
            { country: 'Jordan', count: 1.12, capital: { lat: 31.9516, lon: 35.9257 }, rawCount: '1.12万', continent: 'Asia' }, // 安曼
            { country: 'Syria', count: 0.42, capital: { lat: 33.5138, lon: 36.2919 }, rawCount: '0.42万', continent: 'Asia' }, // 大马士革
            { country: 'Philippines', count: 10.12, capital: { lat: 14.5995, lon: 120.9842 }, rawCount: '10.12万', continent: 'Asia' }, // 马尼拉
            { country: 'Cambodia', count: 1.02, capital: { lat: 11.5564, lon: 104.9282 }, rawCount: '1.02万', continent: 'Asia' }, // 金边
            { country: 'Bangladesh', count: 18.38, capital: { lat: 23.8103, lon: 90.4125 }, rawCount: '18.38万', continent: 'Asia' }, // 达卡
            { country: 'Sri Lanka', count: 8.24, capital: { lat: 6.9271, lon: 79.8612 }, rawCount: '8.24万', continent: 'Asia' }, // 科伦坡
            { country: 'India', count: 239.98, capital: { lat: 28.6139, lon: 77.2090 }, rawCount: '239.98万', continent: 'Asia' }, // 新德里
            { country: 'Afghanistan', count: 0.48, capital: { lat: 34.5552, lon: 69.2074 }, rawCount: '0.48万', continent: 'Asia' }, // 喀布尔
            { country: 'Uzbekistan', count: 3.67, capital: { lat: 41.2995, lon: 69.2401 }, rawCount: '3.67万', continent: 'Asia' }, // 塔什干
            { country: 'Turkmenistan', count: 0.13, capital: { lat: 37.9509, lon: 58.3794 }, rawCount: '0.13万', continent: 'Asia' }, // 阿什哈巴德
            { country: 'Azerbaijan', count: 1.7, capital: { lat: 40.4093, lon: 49.8671 }, rawCount: '1.7万', continent: 'Asia' }, // 巴库
            { country: 'Armenia', count: 2.09, capital: { lat: 40.1772, lon: 44.4971 }, rawCount: '2.09万', continent: 'Asia' }, // 埃里温
            { country: 'Georgia', count: 3.19, capital: { lat: 41.7151, lon: 44.8271 }, rawCount: '3.19万', continent: 'Asia' }, // 第比利斯
            // 北美洲
            { country: 'US', count: 476.16, capital: { lat: 38.9072, lon: -77.0369 }, rawCount: '476.16万', continent: 'NorthAmerica' }, // 华盛顿
            { country: 'Canada', count: 79.69, capital: { lat: 45.4215, lon: -75.6972 }, rawCount: '79.69万', continent: 'NorthAmerica' }, // 渥太华
            { country: 'Mexico', count: 22.23, capital: { lat: 19.4326, lon: -99.1332 }, rawCount: '22.23万', continent: 'NorthAmerica' }, // 墨西哥城
            { country: 'Cuba', count: 0.64, capital: { lat: 23.1136, lon: -82.3666 }, rawCount: '0.64万', continent: 'NorthAmerica' }, // 哈瓦那
            { country: 'Guatemala', count: 1.6, capital: { lat: 14.6349, lon: -90.5069 }, rawCount: '1.6万', continent: 'NorthAmerica' }, // 危地马拉城
            { country: 'Belize', count: 0.06, capital: { lat: 17.2577, lon: -88.7713 }, rawCount: '0.06万', continent: 'NorthAmerica' }, // 贝尔莫潘
            { country: 'Honduras', count: 0.65, capital: { lat: 14.0818, lon: -87.2067 }, rawCount: '0.65万', continent: 'NorthAmerica' }, // 特古西加尔巴
            { country: 'Panama', count: 0.78, capital: { lat: 8.9814, lon: -79.5197 }, rawCount: '0.78万', continent: 'NorthAmerica' }, // 巴拿马城
            { country: 'Costa Rica', count: 2.79, capital: { lat: 9.9347, lon: -84.0876 }, rawCount: '2.79万', continent: 'NorthAmerica' }, // 圣何塞
            { country: 'Greenland', count: 0.04, capital: { lat: 64.1814, lon: -51.6941 }, rawCount: '0.04万', continent: 'Arctic' }, // 努克
            // 欧洲
            { country: 'Russia', count: 57.14, capital: { lat: 55.7558, lon: 37.6173 }, rawCount: '57.14万', continent: 'Europe' }, // 莫斯科
            { country: 'UK', count: 98.3, capital: { lat: 51.5074, lon: -0.1278 }, rawCount: '98.3万', continent: 'Europe' }, // 伦敦
            { country: 'Germany', count: 95.00, capital: { lat: 52.5200, lon: 13.4050 }, rawCount: '95万', continent: 'Europe' }, // 柏林
            { country: 'Ukraine', count: 32.48, capital: { lat: 50.4501, lon: 30.5234 }, rawCount: '32.48万', continent: 'Europe' }, // 基辅
            { country: 'Romania', count: 10.23, capital: { lat: 44.4268, lon: 26.1025 }, rawCount: '10.23万', continent: 'Europe' }, // 布加勒斯特
            { country: 'Italy', count: 27.23, capital: { lat: 41.9028, lon: 12.4964 }, rawCount: '27.23万', continent: 'Europe' }, // 罗马
            { country: 'Spain', count: 36.52, capital: { lat: 40.4168, lon: -3.7038 }, rawCount: '36.52万', continent: 'Europe' }, // 马德里
            { country: 'Portugal', count: 14.69, capital: { lat: 38.7223, lon: -9.1393 }, rawCount: '14.69万', continent: 'Europe' }, // 里斯本
            { country: 'Ireland', count: 7.01, capital: { lat: 53.3498, lon: -6.2603 }, rawCount: '7.01万', continent: 'Europe' }, // 都柏林
            { country: 'Sweden', count: 24.05, capital: { lat: 59.3293, lon: 18.0686 }, rawCount: '24.05万', continent: 'Europe' }, // 斯德哥尔摩
            { country: 'Norway', count: 11.76, capital: { lat: 59.9139, lon: 10.7522 }, rawCount: '11.76万', continent: 'Europe' }, // 奥斯陆
            { country: 'Finland', count: 11.16, capital: { lat: 60.1699, lon: 24.9384 }, rawCount: '11.16万', continent: 'Europe' }, // 赫尔辛基
            { country: 'Estonia', count: 2.29, capital: { lat: 59.4369, lon: 24.7535 }, rawCount: '2.29万', continent: 'Europe' }, // 塔林
            { country: 'Latvia', count: 2.03, capital: { lat: 56.9496, lon: 24.1052 }, rawCount: '2.03万', continent: 'Europe' }, // 里加
            { country: 'Lithuania', count: 3.49, capital: { lat: 54.6872, lon: 25.2797 }, rawCount: '3.49万', continent: 'Europe' }, // 维尔纽斯
            { country: 'Austria', count: 10.81, capital: { lat: 48.2082, lon: 16.3738 }, rawCount: '10.81万', continent: 'Europe' }, // 维也纳
            { country: 'Hungary', count: 6.69, capital: { lat: 47.4979, lon: 19.0402 }, rawCount: '6.69万', continent: 'Europe' }, // 布达佩斯
            { country: 'Belarus', count: 8.54, capital: { lat: 53.9041, lon: 27.5576 }, rawCount: '8.54万', continent: 'Europe' }, // 明斯克
            { country: 'Poland', count: 38.62, capital: { lat: 52.2297, lon: 21.0122 }, rawCount: '38.62万', continent: 'Europe' }, // 华沙
            { country: 'Moldova', count: 1.09, capital: { lat: 47.0105, lon: 28.8638 }, rawCount: '1.09万', continent: 'Europe' }, // 基希讷乌
            // 南美洲
            { country: 'Brazil', count: 80.00, capital: { lat: -15.8267, lon: -47.9218 }, rawCount: '80万', continent: 'SouthAmerica' }, // 巴西利亚
            { country: 'Argentina', count: 25.71, capital: { lat: -34.6118, lon: -58.3960 }, rawCount: '25.71万', continent: 'SouthAmerica' }, // 布宜诺斯艾利斯
            { country: 'Chile', count: 8.34, capital: { lat: -33.4489, lon: -70.6693 }, rawCount: '8.34万', continent: 'SouthAmerica' }, // 圣地亚哥
            { country: 'Colombia', count: 18.35, capital: { lat: 4.7110, lon: -74.0721 }, rawCount: '18.35万', continent: 'SouthAmerica' }, // 波哥大
            { country: 'Venezuela', count: 3.34, capital: { lat: 10.4806, lon: -66.9034 }, rawCount: '3.34万', continent: 'SouthAmerica' }, // 加拉加斯
            { country: 'Peru', count: 6.4, capital: { lat: -12.0464, lon: -77.0428 }, rawCount: '6.4万', continent: 'SouthAmerica' }, // 利马
            { country: 'Bolivia', count: 1.21, capital: { lat: -16.5000, lon: -68.1500 }, rawCount: '1.21万', continent: 'SouthAmerica' }, // 拉巴斯
            { country: 'Paraguay', count: 0.83, capital: { lat: -25.2865, lon: -57.6359 }, rawCount: '0.83万', continent: 'SouthAmerica' }, // 亚松森
            { country: 'Uruguay', count: 2.73, capital: { lat: -34.9011, lon: -56.1645 }, rawCount: '2.73万', continent: 'SouthAmerica' }, // 蒙得维的亚
            // 非洲
            { country: 'Nigeria', count: 17.69, capital: { lat: 9.0820, lon: 8.6753 }, rawCount: '17.69万', continent: 'Africa' }, // 阿布贾
            { country: 'South Africa', count: 10.5, capital: { lat: -25.7479, lon: 28.2293 }, rawCount: '10.5万', continent: 'Africa' }, // 比勒陀利亚
            { country: 'Madagascar', count: 0.63, capital: { lat: -18.9100, lon: 47.5361 }, rawCount: '0.63万', continent: 'Africa' }, // 安塔那那利佛
            { country: 'Botswana', count: 0.15, capital: { lat: -24.6544, lon: 25.9089 }, rawCount: '0.15万', continent: 'Africa' }, // 哈博罗内
            { country: 'Namibia', count: 0.18, capital: { lat: -22.5592, lon: 17.0832 }, rawCount: '0.18万', continent: 'Africa' }, // 温得和克
            { country: 'Sudan', count: 0.33, capital: { lat: 15.5518, lon: 32.5324 }, rawCount: '0.33万', continent: 'Africa' }, // 喀土穆
            { country: 'Ethiopia', count: 2.27, capital: { lat: 9.0350, lon: 38.7469 }, rawCount: '2.27万', continent: 'Africa' }, // 亚的斯亚贝巴
            { country: 'Libya', count: 0.23, capital: { lat: 32.8872, lon: 13.1874 }, rawCount: '0.23万', continent: 'Africa' }, // 的黎波里
            { country: 'Egypt', count: 11.86, capital: { lat: 30.0444, lon: 31.2357 }, rawCount: '11.86万', continent: 'Africa' }, // 开罗
            { country: 'Algeria', count: 2.03, capital: { lat: 36.7525, lon: 3.0420 }, rawCount: '2.03万', continent: 'Africa' }, // 阿尔及尔
            { country: 'Tunisia', count: 3.01, capital: { lat: 36.8065, lon: 10.1815 }, rawCount: '3.01万', continent: 'Africa' }, // 突尼斯
            { country: 'Morocco', count: 4.44, capital: { lat: 34.0209, lon: -6.8416 }, rawCount: '4.44万', continent: 'Africa' }, // 拉巴特
            { country: 'Mauritania', count: 0.06, capital: { lat: 18.0735, lon: -15.9582 }, rawCount: '0.06万', continent: 'Africa' }, // 努瓦克肖特
            // 大洋洲
            { country: 'Australia', count: 38.03, capital: { lat: -35.2809, lon: 149.1300 }, rawCount: '38.03万', continent: 'Oceania' }, // 堪培拉
            { country: 'New Zealand', count: 9.16, capital: { lat: -41.2865, lon: 174.7762 }, rawCount: '9.16万', continent: 'Oceania' }, // 惠灵顿
            { country: 'Papua New Guinea', count: 0.06, capital: { lat: -9.4438, lon: 147.1803 }, rawCount: '0.06万', continent: 'Oceania' }, // 莫尔斯比港
            { country: 'Fiji', count: 0.22, capital: { lat: -18.1416, lon: 178.4419 }, rawCount: '0.22万', continent: 'Oceania' }, // 苏瓦
            // 欧洲（其他）
            { country: 'France', count: 68.88, capital: { lat: 48.8566, lon: 2.3522 }, rawCount: '68.88万', continent: 'Europe' } // 巴黎
        ];

        // 计算最大值用于标准化柱状图高度
        const maxCount = Math.max(...countryData.map(c => c.count));
        
        // 为每个国家创建立方体（添加到地球上作为一个组）
        const countryGroup = new THREE.Group();
        const countryBars = [];
        
        for (const countryObj of countryData) {
            // 根据开发者数量计算立方体高度（最小0.03，最大0.25）
            const height = 0.03 + (countryObj.count / maxCount) * 0.22;
            const width = 0.01; // 立方体宽度
            
            // 创建立方体几何体
            const boxGeometry = new THREE.BoxGeometry(width, height, width);
            const boxMaterial = new THREE.MeshPhongMaterial({ 
                color: continentColors[countryObj.continent],
                transparent: true,
                opacity: 0.8
            });
            const box = new THREE.Mesh(boxGeometry, boxMaterial);
            
            // 使用首都经纬度计算3D位置（在地球表面之上）
            const basePosition = latLongToVector3(
                countryObj.capital.lat, 
                countryObj.capital.lon, 
                1.0 // 地球表面位置
            );
            
            // 设置立方体底部位置（在地球表面上）
            box.position.copy(basePosition.clone().multiplyScalar(1 + height/2));
            
            // 修正：让立方体垂直于地球表面（即指向地球中心的法线方向）
            // 将立方体的向上方向设置为从地球中心指向该点的方向（即径向方向）
            const upVector = new THREE.Vector3(0, 1, 0); // 立方体默认向上方向
            const targetDirection = basePosition.clone().normalize(); // 从地球中心指向该点的方向
            
            // 创建一个四元数来旋转立方体，使其y轴指向地心方向
            const quaternion = new THREE.Quaternion().setFromUnitVectors(upVector, targetDirection);
            box.quaternion.copy(quaternion);

            // 将立方体添加到国家组中
            countryGroup.add(box);
            
            // 存储立方体对象以便后续操作
            countryBars.push({
                mesh: box,
                country: countryObj.country,
                continent: countryObj.continent,
                originalHeight: height,
                originalScale: box.scale.clone(),
                position: basePosition.clone(),
                rawCount: countryObj.rawCount
            });
        }
        
        // 将国家组添加到场景中
        scene.add(countryGroup);

        // 灯光
        const ambientLight = new THREE.AmbientLight(0x404040, 1);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(2, 1, 3).normalize();
        scene.add(directionalLight);

        // 鼠标控制变量
        let isDragging = false;
        let previousMousePosition = {
            x: 0,
            y: 0
        };

        // 鼠标事件处理
        function onMouseDown(event) {
            isDragging = true;
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }

        function onMouseMove(event) {
            if (isDragging) {
                const deltaX = event.clientX - previousMousePosition.x;
                const deltaY = event.clientY - previousMousePosition.y;

                earth.rotation.y += deltaX * 0.01;
                earth.rotation.x += deltaY * 0.01;
                
                // 同时旋转国家立方体组
                countryGroup.rotation.y += deltaX * 0.01;
                countryGroup.rotation.x += deltaY * 0.01;

                previousMousePosition = {
                    x: event.clientX,
                    y: event.clientY
                };
            }

            // 检查鼠标是否悬停在国家立方体上
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            // 检测与立方体的交集
            const intersects = raycaster.intersectObjects(countryBars.map(b => b.mesh));

            // 重置所有立方体的大小
            countryBars.forEach(bar => {
                bar.mesh.scale.copy(bar.originalScale);
            });

            if (intersects.length > 0) {
                // 放大选中的立方体
                const intersectedBar = intersects[0].object;
                const barInfo = countryBars.find(b => b.mesh === intersectedBar);
                if (barInfo) {
                    intersectedBar.scale.set(
                        barInfo.originalScale.x * 1.3,
                        barInfo.originalScale.y * 1.3,
                        barInfo.originalScale.z * 1.3
                    );
                    
                    const tooltip = document.getElementById('tooltip');
                    tooltip.style.left = (event.clientX + 10) + 'px';
                    tooltip.style.top = (event.clientY + 10) + 'px';
                    tooltip.innerHTML = `${barInfo.country} (${barInfo.continent}): ${barInfo.rawCount}`;
                    tooltip.style.display = 'block';
                    return;
                }
            }

            document.getElementById('tooltip').style.display = 'none';
        }

        function onMouseUp() {
            isDragging = false;
        }

        function onMouseLeave() {
            isDragging = false;
            
            // 重置所有立方体的大小
            countryBars.forEach(bar => {
                bar.mesh.scale.copy(bar.originalScale);
            });
            
            document.getElementById('tooltip').style.display = 'none';
        }

        // 禁用右键菜单
        function onContextMenu(e) {
            e.preventDefault();
        }

        // 添加事件监听器
        renderer.domElement.addEventListener('mousedown', onMouseDown, false);
        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('mouseup', onMouseUp, false);
        renderer.domElement.addEventListener('mouseleave', onMouseLeave, false);
        renderer.domElement.addEventListener('contextmenu', onContextMenu, false);

        // 窗口大小调整
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize, false);

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);

            if (!isDragging) {
                earth.rotation.y += 0.001;
                countryGroup.rotation.y += 0.001; // 同步旋转国家立方体组
            }

            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
