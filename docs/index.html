<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球开源开发者3D地球分布模型</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
            font-family: Arial, sans-serif;
        }
        #container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        #instructions {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 10;
        }
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 100;
            display: none;
            border: 1px solid #fff;
        }
        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            z-index: 100;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        #topCountries {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            z-index: 100;
            font-size: 14px;
            min-width: 200px;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .rank-number {
            font-weight: bold;
            color: #44ff44;
        }
        #leftPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            z-index: 100;
            width: 250px;
            font-size: 14px;
        }
        #searchPanel {
            margin-bottom: 15px;
        }
        #searchPanel input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(50, 50, 50, 0.8);
            color: white;
            border: 1px solid #444;
            border-radius: 5px;
        }
        #searchPanel button {
            width: 100%;
            padding: 8px;
            background: #4444ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #statsPanel {
            margin-bottom: 15px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .stat-label {
            color: #aaa;
        }
        .stat-value {
            font-weight: bold;
            color: #44ff44;
        }
        #countryDetails {
            display: none;
        }
        #countryDetails h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #44ff44;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        #countryDetails p {
            margin: 5px 0;
        }
        .detail-label {
            color: #aaa;
        }
        .detail-value {
            font-weight: bold;
            color: #44ff44;
        }
        #searchHint {
            font-size: 12px;
            color: #aaa;
            margin-top: -8px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="instructions">拖动地球旋转 | 拖动鼠标旋转地球</div>
    <div id="container"></div>
    <div id="tooltip"></div>
    
    <div id="leftPanel">
        <div id="searchPanel">
            <input type="text" id="countrySearch" placeholder="搜索国家或地区...">
            <div id="searchHint">输入中文国家名或洲名</div>
            <button onclick="findCountry()">查找国家</button>
        </div>
        
        <div id="statsPanel">
            <h3>全球统计</h3>
            <div class="stat-item">
                <span class="stat-label">总开发者数:</span>
                <span class="stat-value">2,029.53万+</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">覆盖国家:</span>
                <span class="stat-value">242个</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">年增长率:</span>
                <span class="stat-value">+12.3%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">最活跃区域:</span>
                <span class="stat-value">亚洲</span>
            </div>
        </div>
        
        <div id="countryDetails">
            <h3>国家详情</h3>
            <p><span class="detail-label">国家:</span> <span id="countryName" class="detail-value">-</span></p>
            <p><span class="detail-label">洲:</span> <span id="countryContinent" class="detail-value">-</span></p>
            <p><span class="detail-label">开发者数:</span> <span id="countryDevelopers" class="detail-value">-</span></p>
            <p><span class="detail-label">全球排名:</span> <span id="countryRank" class="detail-value">-</span></p>
        </div>
    </div>
    
    <div id="legend">
        <div style="font-weight: bold; margin-bottom: 10px;">洲际分布图例</div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff4444;"></div>
            <span>亚洲 (亚洲)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4444ff;"></div>
            <span>北美洲 (北美洲)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #44ff44;"></div>
            <span>欧洲 (欧洲)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffff44;"></div>
            <span>南美洲 (南美洲)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff44ff;"></div>
            <span>非洲 (非洲)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #44ffff;"></div>
            <span>大洋洲 (大洋洲)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffffff;"></div>
            <span>北极地区 (北极)</span>
        </div>
    </div>
    <div id="topCountries">
        <div style="font-weight: bold; margin-bottom: 10px;">开发者数量排行榜 Top 10</div>
        <div class="rank-item">
            <span class="rank-number">1.</span>
            <span>美国: 476.16万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">2.</span>
            <span>印度: 239.98万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">3.</span>
            <span>中国: 198.29万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">4.</span>
            <span>英国: 98.3万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">5.</span>
            <span>德国: 95万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">6.</span>
            <span>巴西: 80万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">7.</span>
            <span>加拿大: 79.69万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">8.</span>
            <span>法国: 68.88万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">9.</span>
            <span>澳大利亚: 38.03万</span>
        </div>
        <div class="rank-item">
            <span class="rank-number">10.</span>
            <span>俄罗斯: 57.14万</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 经纬度转换为3D坐标的函数
        function latLongToVector3(lat, lon, radius) {
            const phi = (90 - lat) * Math.PI / 180;
            const theta = (lon + 180) * Math.PI / 180;

            return new THREE.Vector3(
                -radius * Math.sin(phi) * Math.cos(theta),
                radius * Math.cos(phi),
                radius * Math.sin(phi) * Math.sin(theta)
            );
        }

        // 场景初始化
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 2;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);

        // 创建基础地球
        const geometry = new THREE.SphereGeometry(1, 64, 64);

        const textureLoader = new THREE.TextureLoader();
        const map = textureLoader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');
        const bumpMap = textureLoader.load('https://threejs.org/examples/textures/planets/earth_normal_2048.jpg');
        const specularMap = textureLoader.load('https://threejs.org/examples/textures/planets/earth_specular_2048.jpg');

        const material = new THREE.MeshPhongMaterial({
            map: map,
            bumpMap: bumpMap,
            bumpScale: 0.05,
            specularMap: specularMap,
            specular: new THREE.Color(0x333333),
            shininess: 5
        });

        const earth = new THREE.Mesh(geometry, material);
        scene.add(earth);

        // 添加地球上的云层
        const cloudGeometry = new THREE.SphereGeometry(1.01, 64, 64);
        const cloudMaterial = new THREE.MeshPhongMaterial({
            map: textureLoader.load('https://threejs.org/examples/textures/planets/earth_clouds_1024.png'),
            transparent: true,
            opacity: 0.4
        });
        const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
        scene.add(clouds);

        // 洲颜色映射
        const continentColors = {
            亚洲: 0xff4444,       // 红色
            北美洲: 0x4444ff, // 蓝色
            欧洲: 0x44ff44,      // 绿色
            南美洲: 0xffff44, // 黄色
            非洲: 0xff44ff,       // 紫红色
            大洋洲: 0x44ffff,     // 青色
            北极: 0xffffff       // 白色
        };

        // 国家开发者数据（使用首都经纬度，按洲分组）
        const countryData = [
            // 亚洲
            { country: '中国', count: 198.29, capital: { lat: 39.9042, lon: 116.4074 }, rawCount: '198.29万', continent: '亚洲', rank: 3 }, // 北京
            { country: '日本', count: 36.79, capital: { lat: 35.6895, lon: 139.6917 }, rawCount: '36.79万', continent: '亚洲', rank: 12 }, // 东京
            { country: '蒙古', count: 0.44, capital: { lat: 47.8864, lon: 106.9057 }, rawCount: '0.44万', continent: '亚洲', rank: 96 }, // 乌兰巴托
            { country: '哈萨克斯坦', count: 3.57, capital: { lat: 51.1605, lon: 71.4704 }, rawCount: '3.57万', continent: '亚洲', rank: 61 }, // 努尔苏丹
            { country: '伊朗', count: 10.36, capital: { lat: 35.6892, lon: 51.3890 }, rawCount: '10.36万', continent: '亚洲', rank: 35 }, // 德黑兰
            { country: '印度尼西亚', count: 36.64, capital: { lat: -6.2088, lon: 106.8456 }, rawCount: '36.64万', continent: '亚洲', rank: 13 }, // 雅加达
            { country: '马来西亚', count: 5.97, capital: { lat: 3.1390, lon: 101.6869 }, rawCount: '5.97万', continent: '亚洲', rank: 50 }, // 吉隆坡
            { country: '泰国', count: 7.64, capital: { lat: 13.7563, lon: 100.5018 }, rawCount: '7.64万', continent: '亚洲', rank: 42 }, // 曼谷
            { country: '越南', count: 21.5, capital: { lat: 21.0278, lon: 105.8342 }, rawCount: '21.5万', continent: '亚洲', rank: 18 }, // 河内
            { country: '巴基斯坦', count: 18.89, capital: { lat: 33.6844, lon: 73.0479 }, rawCount: '18.89万', continent: '亚洲', rank: 21 }, // 伊斯兰堡
            { country: '沙特阿拉伯', count: 3.35, capital: { lat: 24.6877, lon: 46.7219 }, rawCount: '3.35万', continent: '亚洲', rank: 64 }, // 利雅得
            { country: '也门', count: 0.39, capital: { lat: 15.3694, lon: 44.1910 }, rawCount: '0.39万', continent: '亚洲', rank: 99 }, // 萨那
            { country: '以色列', count: 9.14, capital: { lat: 31.7683, lon: 35.2137 }, rawCount: '9.14万', continent: '亚洲', rank: 38 }, // 耶路撒冷
            { country: '约旦', count: 1.12, capital: { lat: 31.9516, lon: 35.9257 }, rawCount: '1.12万', continent: '亚洲', rank: 83 }, // 安曼
            { country: '叙利亚', count: 0.42, capital: { lat: 33.5138, lon: 36.2919 }, rawCount: '0.42万', continent: '亚洲', rank: 97 }, // 大马士革
            { country: '菲律宾', count: 10.12, capital: { lat: 14.5995, lon: 120.9842 }, rawCount: '10.12万', continent: '亚洲', rank: 36 }, // 马尼拉
            { country: '柬埔寨', count: 1.02, capital: { lat: 11.5564, lon: 104.9282 }, rawCount: '1.02万', continent: '亚洲', rank: 85 }, // 金边
            { country: '孟加拉国', count: 18.38, capital: { lat: 23.8103, lon: 90.4125 }, rawCount: '18.38万', continent: '亚洲', rank: 22 }, // 达卡
            { country: '斯里兰卡', count: 8.24, capital: { lat: 6.9271, lon: 79.8612 }, rawCount: '8.24万', continent: '亚洲', rank: 40 }, // 科伦坡
            { country: '印度', count: 239.98, capital: { lat: 28.6139, lon: 77.2090 }, rawCount: '239.98万', continent: '亚洲', rank: 2 }, // 新德里
            { country: '阿富汗', count: 0.48, capital: { lat: 34.5552, lon: 69.2074 }, rawCount: '0.48万', continent: '亚洲', rank: 95 }, // 喀布尔
            { country: '乌兹别克斯坦', count: 3.67, capital: { lat: 41.2995, lon: 69.2401 }, rawCount: '3.67万', continent: '亚洲', rank: 60 }, // 塔什干
            { country: '土库曼斯坦', count: 0.13, capital: { lat: 37.9509, lon: 58.3794 }, rawCount: '0.13万', continent: '亚洲', rank: 102 }, // 阿什哈巴德
            { country: '阿塞拜疆', count: 1.7, capital: { lat: 40.4093, lon: 49.8671 }, rawCount: '1.7万', continent: '亚洲', rank: 76 }, // 巴库
            { country: '亚美尼亚', count: 2.09, capital: { lat: 40.1772, lon: 44.4971 }, rawCount: '2.09万', continent: '亚洲', rank: 72 }, // 埃里温
            { country: '格鲁吉亚', count: 3.19, capital: { lat: 41.7151, lon: 44.8271 }, rawCount: '3.19万', continent: '亚洲', rank: 66 }, // 第比利斯
            // 北美洲
            { country: '美国', count: 476.16, capital: { lat: 38.9072, lon: -77.0369 }, rawCount: '476.16万', continent: '北美洲', rank: 1 }, // 华盛顿
            { country: '加拿大', count: 79.69, capital: { lat: 45.4215, lon: -75.6972 }, rawCount: '79.69万', continent: '北美洲', rank: 7 }, // 渥太华
            { country: '墨西哥', count: 22.23, capital: { lat: 19.4326, lon: -99.1332 }, rawCount: '22.23万', continent: '北美洲', rank: 17 }, // 墨西哥城
            { country: '古巴', count: 0.64, capital: { lat: 23.1136, lon: -82.3666 }, rawCount: '0.64万', continent: '北美洲', rank: 89 }, // 哈瓦那
            { country: '危地马拉', count: 1.6, capital: { lat: 14.6349, lon: -90.5069 }, rawCount: '1.6万', continent: '北美洲', rank: 77 }, // 危地马拉城
            { country: '伯利兹', count: 0.06, capital: { lat: 17.2577, lon: -88.7713 }, rawCount: '0.06万', continent: '北美洲', rank: 104 }, // 贝尔莫潘
            { country: '洪都拉斯', count: 0.65, capital: { lat: 14.0818, lon: -87.2067 }, rawCount: '0.65万', continent: '北美洲', rank: 88 }, // 特古西加尔巴
            { country: '巴拿马', count: 0.78, capital: { lat: 8.9814, lon: -79.5197 }, rawCount: '0.78万', continent: '北美洲', rank: 87 }, // 巴拿马城
            { country: '哥斯达黎加', count: 2.79, capital: { lat: 9.9347, lon: -84.0876 }, rawCount: '2.79万', continent: '北美洲', rank: 70 }, // 圣何塞
            { country: '格陵兰', count: 0.04, capital: { lat: 64.1814, lon: -51.6941 }, rawCount: '0.04万', continent: '北极', rank: 105 }, // 努克
            { country: '波多黎各', count: 0.7, capital: { lat: 18.2208, lon: -66.5901 }, rawCount: '0.7万', continent: '北美洲', rank: 88 }, // 圣胡安
            { country: '萨尔瓦多', count: 1.27, capital: { lat: 13.6989, lon: -89.1910 }, rawCount: '1.27万', continent: '北美洲', rank: 82 }, // 圣萨尔瓦多
            { country: '尼加拉瓜', count: 0.6, capital: { lat: 12.1328, lon: -86.2504 }, rawCount: '0.6万', continent: '北美洲', rank: 90 }, // 马那瓜
            // 欧洲
            { country: '俄罗斯', count: 57.14, capital: { lat: 55.7558, lon: 37.6173 }, rawCount: '57.14万', continent: '欧洲', rank: 10 }, // 莫斯科
            { country: '英国', count: 98.3, capital: { lat: 51.5074, lon: -0.1278 }, rawCount: '98.3万', continent: '欧洲', rank: 4 }, // 伦敦
            { country: '德国', count: 95.00, capital: { lat: 52.5200, lon: 13.4050 }, rawCount: '95万', continent: '欧洲', rank: 5 }, // 柏林
            { country: '乌克兰', count: 32.48, capital: { lat: 50.4501, lon: 30.5234 }, rawCount: '32.48万', continent: '欧洲', rank: 15 }, // 基辅
            { country: '罗马尼亚', count: 10.23, capital: { lat: 44.4268, lon: 26.1025 }, rawCount: '10.23万', continent: '欧洲', rank: 34 }, // 布加勒斯特
            { country: '意大利', count: 27.23, capital: { lat: 41.9028, lon: 12.4964 }, rawCount: '27.23万', continent: '欧洲', rank: 14 }, // 罗马
            { country: '西班牙', count: 36.52, capital: { lat: 40.4168, lon: -3.7038 }, rawCount: '36.52万', continent: '欧洲', rank: 11 }, // 马德里
            { country: '葡萄牙', count: 14.69, capital: { lat: 38.7223, lon: -9.1393 }, rawCount: '14.69万', continent: '欧洲', rank: 25 }, // 里斯本
            { country: '爱尔兰', count: 7.01, capital: { lat: 53.3498, lon: -6.2603 }, rawCount: '7.01万', continent: '欧洲', rank: 43 }, // 都柏林
            { country: '瑞典', count: 24.05, capital: { lat: 59.3293, lon: 18.0686 }, rawCount: '24.05万', continent: '欧洲', rank: 16 }, // 斯德哥尔摩
            { country: '挪威', count: 11.76, capital: { lat: 59.9139, lon: 10.7522 }, rawCount: '11.76万', continent: '欧洲', rank: 30 }, // 奥斯陆
            { country: '芬兰', count: 11.16, capital: { lat: 60.1699, lon: 24.9384 }, rawCount: '11.16万', continent: '欧洲', rank: 31 }, // 赫尔辛基
            { country: '爱沙尼亚', count: 2.29, capital: { lat: 59.4369, lon: 24.7535 }, rawCount: '2.29万', continent: '欧洲', rank: 71 }, // 塔林
            { country: '拉脱维亚', count: 2.03, capital: { lat: 56.9496, lon: 24.1052 }, rawCount: '2.03万', continent: '欧洲', rank: 73 }, // 里加
            { country: '立陶宛', count: 3.49, capital: { lat: 54.6872, lon: 25.2797 }, rawCount: '3.49万', continent: '欧洲', rank: 62 }, // 维尔纽斯
            { country: '奥地利', count: 10.81, capital: { lat: 48.2082, lon: 16.3738 }, rawCount: '10.81万', continent: '欧洲', rank: 32 }, // 维也纳
            { country: '匈牙利', count: 6.69, capital: { lat: 47.4979, lon: 19.0402 }, rawCount: '6.69万', continent: '欧洲', rank: 44 }, // 布达佩斯
            { country: '白俄罗斯', count: 8.54, capital: { lat: 53.9041, lon: 27.5576 }, rawCount: '8.54万', continent: '欧洲', rank: 41 }, // 明斯克
            { country: '波兰', count: 38.62, capital: { lat: 52.2297, lon: 21.0122 }, rawCount: '38.62万', continent: '欧洲', rank: 9 }, // 华沙
            { country: '摩尔多瓦', count: 1.09, capital: { lat: 47.0105, lon: 28.8638 }, rawCount: '1.09万', continent: '欧洲', rank: 84 }, // 基希讷乌
            { country: '瑞士', count: 18.11, capital: { lat: 46.9480, lon: 7.4474 }, rawCount: '18.11万', continent: '欧洲', rank: 20 }, // 伯尔尼
            { country: '希腊', count: 7.03, capital: { lat: 37.9838, lon: 23.7275 }, rawCount: '7.03万', continent: '欧洲', rank: 43 }, // 雅典
            { country: '保加利亚', count: 6.82, capital: { lat: 42.6977, lon: 23.3219 }, rawCount: '6.82万', continent: '欧洲', rank: 45 }, // 索非亚
            { country: '丹麦', count: 11.66, capital: { lat: 55.6761, lon: 12.5683 }, rawCount: '11.66万', continent: '欧洲', rank: 31 }, // 哥本哈根
            // 南美洲
            { country: '巴西', count: 80.00, capital: { lat: -15.8267, lon: -47.9218 }, rawCount: '80万', continent: '南美洲', rank: 6 }, // 巴西利亚
            { country: '阿根廷', count: 25.71, capital: { lat: -34.6118, lon: -58.3960 }, rawCount: '25.71万', continent: '南美洲', rank: 13 }, // 布宜诺斯艾利斯
            { country: '智利', count: 8.34, capital: { lat: -33.4489, lon: -70.6693 }, rawCount: '8.34万', continent: '南美洲', rank: 40 }, // 圣地亚哥
            { country: '哥伦比亚', count: 18.35, capital: { lat: 4.7110, lon: -74.0721 }, rawCount: '18.35万', continent: '南美洲', rank: 22 }, // 波哥大
            { country: '委内瑞拉', count: 3.34, capital: { lat: 10.4806, lon: -66.9034 }, rawCount: '3.34万', continent: '南美洲', rank: 65 }, // 加拉加斯
            { country: '秘鲁', count: 6.4, capital: { lat: -12.0464, lon: -77.0428 }, rawCount: '6.4万', continent: '南美洲', rank: 46 }, // 利马
            { country: '玻利维亚', count: 1.21, capital: { lat: -16.5000, lon: -68.1500 }, rawCount: '1.21万', continent: '南美洲', rank: 82 }, // 拉巴斯
            { country: '巴拉圭', count: 0.83, capital: { lat: -25.2865, lon: -57.6359 }, rawCount: '0.83万', continent: '南美洲', rank: 86 }, // 亚松森
            { country: '乌拉圭', count: 2.73, capital: { lat: -34.9011, lon: -56.1645 }, rawCount: '2.73万', continent: '南美洲', rank: 70 }, // 蒙得维的亚
            { country: '厄瓜多尔', count: 2.81, capital: { lat: -0.2299, lon: -78.5249 }, rawCount: '2.81万', continent: '南美洲', rank: 69 }, // 基多
            { country: '苏里南', count: 0.05, capital: { lat: 5.8520, lon: -55.2038 }, rawCount: '0.05万', continent: '南美洲', rank: 106 }, // 帕拉马里博
            { country: '圭亚那', count: 0.04, capital: { lat: 6.8013, lon: -58.1553 }, rawCount: '0.04万', continent: '南美洲', rank: 107 }, // 乔治敦
            // 非洲
            { country: '尼日利亚', count: 17.69, capital: { lat: 9.0820, lon: 8.6753 }, rawCount: '17.69万', continent: '非洲', rank: 23 }, // 阿布贾
            { country: '南非', count: 10.5, capital: { lat: -25.7479, lon: 28.2293 }, rawCount: '10.5万', continent: '非洲', rank: 33 }, // 比勒陀利亚
            { country: '马达加斯加', count: 0.63, capital: { lat: -18.9100, lon: 47.5361 }, rawCount: '0.63万', continent: '非洲', rank: 90 }, // 安塔那那利佛
            { country: '博茨瓦纳', count: 0.15, capital: { lat: -24.6544, lon: 25.9089 }, rawCount: '0.15万', continent: '非洲', rank: 101 }, // 哈博罗内
            { country: '纳米比亚', count: 0.18, capital: { lat: -22.5592, lon: 17.0832 }, rawCount: '0.18万', continent: '非洲', rank: 100 }, // 温得和克
            { country: '苏丹', count: 0.33, capital: { lat: 15.5518, lon: 32.5324 }, rawCount: '0.33万', continent: '非洲', rank: 98 }, // 喀土穆
            { country: '埃塞俄比亚', count: 2.27, capital: { lat: 9.0350, lon: 38.7469 }, rawCount: '2.27万', continent: '非洲', rank: 71 }, // 亚的斯亚贝巴
            { country: '利比亚', count: 0.23, capital: { lat: 32.8872, lon: 13.1874 }, rawCount: '0.23万', continent: '非洲', rank: 98 }, // 的黎波里
            { country: '埃及', count: 11.86, capital: { lat: 30.0444, lon: 31.2357 }, rawCount: '11.86万', continent: '非洲', rank: 29 }, // 开罗
            { country: '阿尔及利亚', count: 2.03, capital: { lat: 36.7525, lon: 3.0420 }, rawCount: '2.03万', continent: '非洲', rank: 73 }, // 阿尔及尔
            { country: '突尼斯', count: 3.01, capital: { lat: 36.8065, lon: 10.1815 }, rawCount: '3.01万', continent: '非洲', rank: 67 }, // 突尼斯
            { country: '摩洛哥', count: 4.44, capital: { lat: 34.0209, lon: -6.8416 }, rawCount: '4.44万', continent: '非洲', rank: 54 }, // 拉巴特
            { country: '毛里塔尼亚', count: 0.06, capital: { lat: 18.0735, lon: -15.9582 }, rawCount: '0.06万', continent: '非洲', rank: 104 }, // 努瓦克肖特
            { country: '加蓬', count: 0.05, capital: { lat: 0.3475, lon: 9.4287 }, rawCount: '0.05万', continent: '非洲', rank: 106 }, // 利伯维尔
            { country: '喀麦隆', count: 1.23, capital: { lat: 3.8667, lon: 11.5167 }, rawCount: '1.23万', continent: '非洲', rank: 81 }, // 雅温得
            { country: '贝宁', count: 0.39, capital: { lat: 6.4965, lon: 2.6037 }, rawCount: '0.39万', continent: '非洲', rank: 99 }, // 波多诺伏
            { country: '多哥', count: 0.22, capital: { lat: 6.1282, lon: 1.2215 }, rawCount: '0.22万', continent: '非洲', rank: 99 }, // 洛美
            { country: '加纳', count: 3.3, capital: { lat: 5.5560, lon: -0.1969 }, rawCount: '3.3万', continent: '非洲', rank: 65 }, // 阿克拉
            { country: '肯尼亚', count: 9.37, capital: { lat: -1.2921, lon: 36.8219 }, rawCount: '9.37万', continent: '非洲', rank: 37 }, // 内罗毕
            { country: '乌干达', count: 1.8, capital: { lat: 0.3476, lon: 32.5825 }, rawCount: '1.8万', continent: '非洲', rank: 75 }, // 坎帕拉
            { country: '坦桑尼亚', count: 0.95, capital: { lat: -6.7924, lon: 39.2083 }, rawCount: '0.95万', continent: '非洲', rank: 86 }, // 达累斯萨拉姆
            { country: '卢旺达', count: 1.21, capital: { lat: -1.9403, lon: 30.0588 }, rawCount: '1.21万', continent: '非洲', rank: 82 }, // 基加利
            { country: '布隆迪', count: 0.07, capital: { lat: -3.3869, lon: 29.3622 }, rawCount: '0.07万', continent: '非洲', rank: 103 }, // 布琼布拉
            { country: '索马里', count: 0.3, capital: { lat: 2.0371, lon: 45.3437 }, rawCount: '0.3万', continent: '非洲', rank: 100 }, // 摩加迪沙
            { country: '塞内加尔', count: 0.58, capital: { lat: 14.7167, lon: -17.4677 }, rawCount: '0.58万', continent: '非洲', rank: 91 }, // 达喀尔
            { country: '几内亚比绍', count: 0.01, capital: { lat: 11.8636, lon: -15.5957 }, rawCount: '0.01万', continent: '非洲', rank: 108 }, // 比绍
            { country: '比绍', count: 0.08, capital: { lat: 11.8636, lon: -15.5957 }, rawCount: '0.08万', continent: '非洲', rank: 103 }, // 比绍（特殊条目）
            { country: '马里', count: 0.09, capital: { lat: 12.6392, lon: -8.0029 }, rawCount: '0.09万', continent: '非洲', rank: 102 }, // 巴马科
            { country: '尼日尔', count: 0.05, capital: { lat: 13.5137, lon: 2.1098 }, rawCount: '0.05万', continent: '非洲', rank: 106 }, // 尼亚梅
            { country: '乍得', count: 0.04, capital: { lat: 12.1348, lon: 15.0557 }, rawCount: '0.04万', continent: '非洲', rank: 107 }, // 恩贾梅纳
            { country: '安哥拉', count: 0.71, capital: { lat: -8.8368, lon: 13.2343 }, rawCount: '0.71万', continent: '非洲', rank: 88 }, // 罗安达
            { country: '厄立特里亚', count: 0.01, capital: { lat: 15.3386, lon: 38.9318 }, rawCount: '0.01万', continent: '非洲', rank: 108 }, // 阿斯马拉
            // 大洋洲
            { country: '澳大利亚', count: 38.03, capital: { lat: -35.2809, lon: 149.1300 }, rawCount: '38.03万', continent: '大洋洲', rank: 9 }, // 堪培拉
            { country: '新西兰', count: 9.16, capital: { lat: -41.2865, lon: 174.7762 }, rawCount: '9.16万', continent: '大洋洲', rank: 38 }, // 惠灵顿
            { country: '巴布亚新几内亚', count: 0.06, capital: { lat: -9.4438, lon: 147.1803 }, rawCount: '0.06万', continent: '大洋洲', rank: 104 }, // 莫尔斯比港
            { country: '斐济', count: 0.22, capital: { lat: -18.1416, lon: 178.4419 }, rawCount: '0.22万', continent: '大洋洲', rank: 99 }, // 苏瓦
            { country: '新喀里多尼亚', count: 0.1, capital: { lat: -22.2713, lon: 166.4447 }, rawCount: '0.1万', continent: '大洋洲', rank: 102 }, // 努美阿
            { country: '瓦努阿图', count: 0.02, capital: { lat: -17.7333, lon: 168.3167 }, rawCount: '0.02万', continent: '大洋洲', rank: 107 }, // 维拉港
            // 中东
            { country: '阿曼', count: 0.27, capital: { lat: 23.5841, lon: 58.4079 }, rawCount: '0.27万', continent: '亚洲', rank: 99 }, // 马斯喀特
            { country: '阿拉伯联合酋长国', count: 5.14, capital: { lat: 24.4539, lon: 54.3773 }, rawCount: '5.14万', continent: '亚洲', rank: 52 }, // 阿布扎比
            { country: '卡塔尔', count: 0.38, capital: { lat: 25.2854, lon: 51.5310 }, rawCount: '0.38万', continent: '亚洲', rank: 99 }, // 多哈
            { country: '科威特', count: 0.37, capital: { lat: 29.3759, lon: 47.9805 }, rawCount: '0.37万', continent: '亚洲', rank: 100 }, // 科威特城
            // 欧洲（新增）
            { country: '法国', count: 68.88, capital: { lat: 48.8566, lon: 2.3522 }, rawCount: '68.88万', continent: '欧洲', rank: 8 }, // 巴黎
            { country: '卢森堡', count: 1.16, capital: { lat: 49.6116, lon: 6.1319 }, rawCount: '1.16万', continent: '欧洲', rank: 83 }, // 卢森堡市
            { country: '冰岛', count: 0.97, capital: { lat: 64.1466, lon: -21.9426 }, rawCount: '0.97万', continent: '欧洲', rank: 86 }, // 雷克雅未克
            { country: '斯洛文尼亚', count: 1.94, capital: { lat: 46.0569, lon: 14.5058 }, rawCount: '1.94万', continent: '欧洲', rank: 74 }, // 卢布尔雅那
            { country: '克罗地亚', count: 3.5, capital: { lat: 45.8150, lon: 15.9820 }, rawCount: '3.5万', continent: '欧洲', rank: 63 }, // 萨格勒布
            { country: '黑山', count: 0.56, capital: { lat: 42.4304, lon: 19.2594 }, rawCount: '0.56万', continent: '欧洲', rank: 90 }, // 波德戈里察
            { country: '阿尔巴尼亚', count: 0.53, capital: { lat: 41.3275, lon: 19.8189 }, rawCount: '0.53万', continent: '欧洲', rank: 91 }, // 地拉那
            { country: '塞浦路斯', count: 1.4, capital: { lat: 35.1856, lon: 33.3823 }, rawCount: '1.4万', continent: '欧洲', rank: 79 }, // 尼科西亚
            { country: '黎巴嫩', count: 1.02, capital: { lat: 33.8938, lon: 35.5018 }, rawCount: '1.02万', continent: '亚洲', rank: 85 }, // 贝鲁特
            { country: '吉布提', count: 0.01, capital: { lat: 11.5890, lon: 43.1450 }, rawCount: '0.01万', continent: '非洲', rank: 108 } // 吉布提市
        ];

        // 按开发者数量排序并分配排名
        countryData.sort((a, b) => b.count - a.count);
        countryData.forEach((country, index) => {
            country.rank = index + 1;
        });

        // 计算最大值用于标准化柱状图高度
        const maxCount = Math.max(...countryData.map(c => c.count));
        
        // 为每个国家创建立方体（添加到地球上作为一个组）
        const countryGroup = new THREE.Group();
        const countryBars = [];
        
        for (const countryObj of countryData) {
            // 根据开发者数量计算立方体高度（最小0.03，最大0.25）
            const height = 0.03 + (countryObj.count / maxCount) * 0.22;
            const width = 0.01; // 立方体宽度
            
            // 创建立方体几何体
            const boxGeometry = new THREE.BoxGeometry(width, height, width);
            const boxMaterial = new THREE.MeshPhongMaterial({ 
                color: continentColors[countryObj.continent],
                transparent: true,
                opacity: 0.8
            });
            const box = new THREE.Mesh(boxGeometry, boxMaterial);
            
            // 使用首都经纬度计算3D位置（在地球表面之上）
            const basePosition = latLongToVector3(
                countryObj.capital.lat, 
                countryObj.capital.lon, 
                1.0 // 地球表面位置
            );
            
            // 设置立方体底部位置（在地球表面上）
            box.position.copy(basePosition.clone().multiplyScalar(1 + height/2));
            
            // 修正：让立方体垂直于地球表面（即指向地球中心的法线方向）
            // 将立方体的向上方向设置为从地球中心指向该点的方向（即径向方向）
            const upVector = new THREE.Vector3(0, 1, 0); // 立方体默认向上方向
            const targetDirection = basePosition.clone().normalize(); // 从地球中心指向该点的方向
            
            // 创建一个四元数来旋转立方体，使其y轴指向地心方向
            const quaternion = new THREE.Quaternion().setFromUnitVectors(upVector, targetDirection);
            box.quaternion.copy(quaternion);

            // 将立方体添加到国家组中
            countryGroup.add(box);
            
            // 存储立方体对象以便后续操作
            countryBars.push({
                mesh: box,
                country: countryObj.country,
                continent: countryObj.continent,
                originalHeight: height,
                originalScale: box.scale.clone(),
                position: basePosition.clone(),
                rawCount: countryObj.rawCount,
                rank: countryObj.rank,
                capital: countryObj.capital
            });
        }
        
        // 将国家组添加到场景中
        scene.add(countryGroup);

        // 灯光
        const ambientLight = new THREE.AmbientLight(0x404040, 1);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(2, 1, 3).normalize();
        scene.add(directionalLight);

        // 鼠标控制变量
        let isDragging = false;
        let previousMousePosition = {
            x: 0,
            y: 0
        };

        // 鼠标事件处理
        function onMouseDown(event) {
            isDragging = true;
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }

        function onMouseMove(event) {
            if (isDragging) {
                const deltaX = event.clientX - previousMousePosition.x;
                const deltaY = event.clientY - previousMousePosition.y;

                earth.rotation.y += deltaX * 0.01;
                earth.rotation.x += deltaY * 0.01;
                
                // 同时旋转国家立方体组
                countryGroup.rotation.y += deltaX * 0.01;
                countryGroup.rotation.x += deltaY * 0.01;

                previousMousePosition = {
                    x: event.clientX,
                    y: event.clientY
                };
            }

            // 检查鼠标是否悬停在国家立方体上
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            // 检测与立方体的交集
            const intersects = raycaster.intersectObjects(countryBars.map(b => b.mesh));

            // 重置所有立方体的大小
            countryBars.forEach(bar => {
                bar.mesh.scale.copy(bar.originalScale);
            });

            if (intersects.length > 0) {
                // 放大选中的立方体
                const intersectedBar = intersects[0].object;
                const barInfo = countryBars.find(b => b.mesh === intersectedBar);
                if (barInfo) {
                    intersectedBar.scale.set(
                        barInfo.originalScale.x * 1.3,
                        barInfo.originalScale.y * 1.3,
                        barInfo.originalScale.z * 1.3
                    );
                    
                    const tooltip = document.getElementById('tooltip');
                    tooltip.style.left = (event.clientX + 10) + 'px';
                    tooltip.style.top = (event.clientY + 10) + 'px';
                    tooltip.innerHTML = `${barInfo.country} (${barInfo.continent}): ${barInfo.rawCount}`;
                    tooltip.style.display = 'block';
                    
                    // 更新左侧国家详情面板
                    document.getElementById('countryName').textContent = barInfo.country;
                    document.getElementById('countryContinent').textContent = barInfo.continent;
                    document.getElementById('countryDevelopers').textContent = barInfo.rawCount;
                    document.getElementById('countryRank').textContent = '#' + barInfo.rank;
                    document.getElementById('countryDetails').style.display = 'block';
                    return;
                }
            }

            document.getElementById('tooltip').style.display = 'none';
            document.getElementById('countryDetails').style.display = 'none';
        }

        function onMouseUp() {
            isDragging = false;
        }

        function onMouseLeave() {
            isDragging = false;
            
            // 重置所有立方体的大小
            countryBars.forEach(bar => {
                bar.mesh.scale.copy(bar.originalScale);
            });
            
            document.getElementById('tooltip').style.display = 'none';
            document.getElementById('countryDetails').style.display = 'none';
        }

        // 禁用右键菜单
        function onContextMenu(e) {
            e.preventDefault();
        }

        // 添加事件监听器
        renderer.domElement.addEventListener('mousedown', onMouseDown, false);
        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('mouseup', onMouseUp, false);
        renderer.domElement.addEventListener('mouseleave', onMouseLeave, false);
        renderer.domElement.addEventListener('contextmenu', onContextMenu, false);

        // 窗口大小调整
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize, false);

        // 搜索功能 - 使用缓动动画平滑过渡
        let isAnimating = false;
        
        function findCountry() {
            if (isAnimating) return; // 如果正在动画中，则返回
            
            const searchValue = document.getElementById('countrySearch').value.trim().toLowerCase();
            if (!searchValue) return;
            
            const foundCountry = countryBars.find(bar => 
                bar.country.toLowerCase().includes(searchValue) || 
                bar.continent.toLowerCase().includes(searchValue)
            );
            
            if (foundCountry) {
                // 重置所有立方体的大小
                countryBars.forEach(bar => {
                    bar.mesh.scale.copy(bar.originalScale);
                });
                
                // 放大选中的立方体
                foundCountry.mesh.scale.set(
                    foundCountry.originalScale.x * 1.5,
                    foundCountry.originalScale.y * 1.5,
                    foundCountry.originalScale.z * 1.5
                );
                
                // 更新国家详情面板
                document.getElementById('countryName').textContent = foundCountry.country;
                document.getElementById('countryContinent').textContent = foundCountry.continent;
                document.getElementById('countryDevelopers').textContent = foundCountry.rawCount;
                document.getElementById('countryRank').textContent = '#' + foundCountry.rank;
                document.getElementById('countryDetails').style.display = 'block';
                
                // 获取目标国家的经纬度
                const targetLat = foundCountry.capital.lat;
                const targetLon = foundCountry.capital.lon;
                
                // 计算目标位置的欧拉角
                const targetPhi = (90 - targetLat) * Math.PI / 180;
                const targetTheta = (targetLon + 180) * Math.PI / 180;
                
                // 计算当前旋转角度
                const currentRotationY = earth.rotation.y % (Math.PI * 2);
                const currentRotationX = earth.rotation.x % (Math.PI * 2);
                
                // 计算目标旋转角度
                let targetRotationY = -targetTheta;
                let targetRotationX = targetPhi - Math.PI/2;
                
                // 修正旋转角度范围，避免跳跃
                targetRotationY = ((targetRotationY - currentRotationY + Math.PI) % (Math.PI * 2)) - Math.PI + currentRotationY;
                targetRotationX = ((targetRotationX - currentRotationX + Math.PI) % (Math.PI * 2)) - Math.PI + currentRotationX;
                
                // 缓动动画参数
                let startTime = null;
                const duration = 1500; // 动画持续时间（毫秒）
                
                function animateRotation(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min(1, (timestamp - startTime) / duration);
                    
                    // 使用缓动函数（easeOutCubic）
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    
                    // 插值计算当前旋转角度
                    earth.rotation.y = currentRotationY + (targetRotationY - currentRotationY) * easeProgress;
                    earth.rotation.x = currentRotationX + (targetRotationX - currentRotationX) * easeProgress;
                    
                    // 同步旋转国家立方体组
                    countryGroup.rotation.y = earth.rotation.y;
                    countryGroup.rotation.x = earth.rotation.x;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateRotation);
                    } else {
                        isAnimating = false; // 动画结束
                    }
                }
                
                isAnimating = true;
                requestAnimationFrame(animateRotation);
            } else {
                alert('未找到匹配的国家或地区');
            }
        }

        // 监听回车键
        document.getElementById('countrySearch').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                findCountry();
            }
        });

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);

            if (!isDragging && !isAnimating) {
                earth.rotation.y += 0.001;
                countryGroup.rotation.y += 0.001; // 同步旋转国家立方体组
                clouds.rotation.y += 0.0015; // 云层稍快旋转
            }

            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
